import{v as we}from"./arrow-right-b75290c7.js";import{r as C,a as s,R as E,av as xe,di as ye,dU as J,dV as ee,_ as h,dW as g,at as I,dX as te,dY as T,dZ as ae,W as b,d as Ce,a7 as _e,u as Se,aL as ke,q as be,F as Ie,Q as Ee,aM as Le,aC as Ne,aO as Me,a2 as Re,H as O,aG as B,a5 as Pe,d_ as De,A as G,d$ as Ae,df as ze,o as Te,e0 as $e,aP as He,aQ as Oe}from"../index-9e17f5e3.js";import{V as Be,a as Ve}from"./index-5f29366d.js";import{v as We}from"./arrows-minimize-7c27a12c.js";import{v as qe}from"./download-ac53125a.js";import{R as Ue}from"./index-974c109d.js";import Xe from"./index-a2321612.js";import{T as je}from"./thread-50633f20.js";import"./volume-08f8a8f1.js";import"./web.url.constructor-f4ee441b.js";import"./object-assign-c33afcf3.js";import"./es.array.last-index-of-cc953e35.js";import"./media-aspect-ratio-df6a7bb1.js";import"./warning-07d0fac9.js";import"./scrollable-list-eb658266.js";import"./index-be0f345e.js";import"./load-more-3e41ca82.js";import"./pending-status-c1bdb605.js";import"./poll-preview-b319ea05.js";import"./noop-a3c45aac.js";import"./status-container-40a12bc1.js";var Fe=function(o){var i=o.src,e=o.alt,t=o.time,r=o.controls,d=o.muted,n=o.onClick,l=C.useRef(null);C.useEffect(function(){var c,p=function(){t&&(l.current.currentTime=t)};return(c=l.current)===null||c===void 0||c.addEventListener("loadeddata",p),function(){var v;(v=l.current)===null||v===void 0||v.removeEventListener("loadeddata",p)}},[l.current]);var f=function(p){p.stopPropagation();var v=n;v&&v()},m={};return ye()&&(m.playsInline=!0),s("div",{className:"extended-video-player"},void 0,E.createElement("video",xe({ref:l,src:i,autoPlay:!0,role:"button",tabIndex:0,"aria-label":e,title:e,muted:d,controls:r,loop:!r,onClick:f},m)))};function Ye(w){var o=Ke();return function(){var e=T(w),t;if(o){var r=T(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return ae(this,t)}}function Ke(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var Z=1,Ge=4,Ze=function(o,i){return{x:(o.clientX+i.clientX)/2,y:(o.clientY+i.clientY)/2}},Q=function(o,i){return Math.sqrt(Math.pow(o.clientX-i.clientX,2)+Math.pow(o.clientY-i.clientY,2))},Qe=function(o,i,e){return Math.min(i,Math.max(o,e))},re=function(w){J(i,w);var o=Ye(i);function i(){var e;ee(this,i);for(var t=arguments.length,r=new Array(t),d=0;d<t;d++)r[d]=arguments[d];return e=o.call.apply(o,[this].concat(r)),h(g(e),"state",{scale:Z}),h(g(e),"container",null),h(g(e),"image",null),h(g(e),"lastDistance",0),h(g(e),"handleTouchStart",function(n){if(n.touches.length===2){var l=Array.from(n.touches),f=I(l,2),m=f[0],c=f[1];e.lastDistance=Q(m,c)}}),h(g(e),"handleTouchMove",function(n){if(e.container){var l=e.container,f=l.scrollTop,m=l.scrollHeight,c=l.clientHeight;if(n.touches.length===1&&f!==m-c){n.stopPropagation();return}if(n.touches.length===2){n.preventDefault(),n.stopPropagation();var p=Array.from(n.touches),v=I(p,2),x=v[0],y=v[1],S=Q(x,y),k=Ze(x,y),_=Qe(Z,Ge,e.state.scale*S/e.lastDistance);e.zoom(_,k),e.lastDistance=S}}}),h(g(e),"handleClick",function(n){n.stopPropagation();var l=e.props.onClick;l&&l(n)}),h(g(e),"setContainerRef",function(n){e.container=n}),h(g(e),"setImageRef",function(n){e.image=n}),e}return te(i,[{key:"componentDidMount",value:function(){var t,r;(t=this.container)===null||t===void 0||t.addEventListener("touchstart",this.handleTouchStart),(r=this.container)===null||r===void 0||r.addEventListener("touchmove",this.handleTouchMove,{passive:!1})}},{key:"componentWillUnmount",value:function(){var t,r;(t=this.container)===null||t===void 0||t.removeEventListener("touchstart",this.handleTouchStart),(r=this.container)===null||r===void 0||r.removeEventListener("touchend",this.handleTouchMove)}},{key:"zoom",value:function(t,r){var d=this;if(this.container){var n=this.state.scale,l=this.container,f=l.scrollLeft,m=l.scrollTop,c=(f+r.x)*t/n-r.x,p=(m+r.y)*t/n-r.y;this.setState({scale:t},function(){d.container&&(d.container.scrollLeft=c,d.container.scrollTop=p)})}}},{key:"render",value:function(){var t=this.props,r=t.alt,d=t.src,n=this.state.scale,l=n===1?"hidden":"scroll";return E.createElement("div",{className:"zoomable-image",ref:this.setContainerRef,style:{overflow:l}},E.createElement("img",{role:"presentation",ref:this.setImageRef,alt:r,title:r,src:d,style:{transform:"scale(".concat(n,")"),transformOrigin:"0 0"},onClick:this.handleClick}))}}]),i}(E.PureComponent);h(re,"defaultProps",{alt:"",width:null,height:null});function Je(w){var o=et();return function(){var e=T(w),t;if(o){var r=T(this).constructor;t=Reflect.construct(e,arguments,r)}else t=e.apply(this,arguments);return ae(this,t)}}function et(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var ne=function(w){J(i,w);var o=Je(i);function i(){var e;ee(this,i);for(var t=arguments.length,r=new Array(t),d=0;d<t;d++)r[d]=arguments[d];return e=o.call.apply(o,[this].concat(r)),h(g(e),"state",{loading:!0,error:!1,width:null}),h(g(e),"removers",[]),h(g(e),"canvas",null),h(g(e),"_canvasContext",null),h(g(e),"loadPreviewCanvas",function(n){var l=n.previewSrc,f=n.width,m=n.height;return new Promise(function(c,p){var v=new Image,x=function(){v.removeEventListener("error",y),v.removeEventListener("load",S)},y=function(){x(),p()},S=function(){var _;x(),(_=e.canvasContext)===null||_===void 0||_.drawImage(v,0,0,f||0,m||0),c()};v.addEventListener("error",y),v.addEventListener("load",S),v.src=l||"",e.removers.push(x)})}),h(g(e),"loadOriginalImage",function(n){var l=n.src;return new Promise(function(f,m){var c=new Image,p=function(){c.removeEventListener("error",v),c.removeEventListener("load",x)},v=function(){p(),m()},x=function(){p(),f()};c.addEventListener("error",v),c.addEventListener("load",x),c.src=l,e.removers.push(p)})}),h(g(e),"setCanvasRef",function(n){e.canvas=n,n&&e.setState({width:n.offsetWidth})}),e}return te(i,[{key:"canvasContext",get:function(){return this.canvas?(this._canvasContext=this._canvasContext||this.canvas.getContext("2d"),this._canvasContext):null}},{key:"componentDidMount",value:function(){this.loadImage(this.props)}},{key:"componentDidUpdate",value:function(t){t.src!==this.props.src&&this.loadImage(this.props)}},{key:"componentWillUnmount",value:function(){this.removeEventListeners()}},{key:"loadImage",value:function(t){var r=this;this.removeEventListeners(),this.setState({loading:!0,error:!1}),Promise.all([t.previewSrc&&this.loadPreviewCanvas(t),this.hasSize()&&this.loadOriginalImage(t)].filter(Boolean)).then(function(){r.setState({loading:!1,error:!1}),r.clearPreviewCanvas()}).catch(function(){return r.setState({loading:!1,error:!0})})}},{key:"clearPreviewCanvas",value:function(){if(this.canvas&&this.canvasContext){var t=this.canvas,r=t.width,d=t.height;this.canvasContext.clearRect(0,0,r,d)}}},{key:"removeEventListeners",value:function(){this.removers.forEach(function(t){return t()}),this.removers=[]}},{key:"hasSize",value:function(){var t=this.props,r=t.width,d=t.height;return typeof r=="number"&&typeof d=="number"}},{key:"render",value:function(){var t=this.props,r=t.alt,d=t.src,n=t.width,l=t.height,f=t.onClick,m=this.state.loading,c=b("image-loader",{"image-loader--loading":m,"image-loader--amorphous":!this.hasSize()});return s("div",{className:c},void 0,m?E.createElement("canvas",{className:"image-loader__preview-canvas",ref:this.setCanvasRef,width:n,height:l}):s(re,{alt:r,src:d,onClick:f}))}}]),i}(E.PureComponent);h(ne,"defaultProps",{alt:"",width:null,height:null});var P=Te({close:{id:"lightbox.close",defaultMessage:"Close"},expand:{id:"lightbox.expand",defaultMessage:"Expand"},minimize:{id:"lightbox.minimize",defaultMessage:"Minimize"},next:{id:"lightbox.next",defaultMessage:"Next"},previous:{id:"lightbox.previous",defaultMessage:"Previous"}}),tt={width:"100%",height:"100%"},at={alignItems:"center"},kt=function(o){var i=o.media,e=o.status,t=o.onClose,r=o.time,d=r===void 0?0:r,n=Ce(),l=_e(),f=Se(),m=C.useCallback(ke(),[]),c=be(function(a){return m(a,{id:e==null?void 0:e.id})}),p=C.useState(!!e),v=I(p,2),x=v[0],y=v[1],S=C.useState(),k=I(S,2),_=k[0],V=k[1],ie=C.useState(null),W=I(ie,2),D=W[0],$=W[1],oe=C.useState(!1),q=I(oe,2),se=q[0],le=q[1],ce=C.useState(!e),U=I(ce,2),L=U[0],ue=U[1],H=i.size>1,de=function(u){return $(u%i.size)},X=function(){return $((z()+1)%i.size)},j=function(){return $((i.size+z()-1)%i.size)},A=se?"pointer-events-none opacity-0":"",F=function(u){switch(u.key){case"ArrowLeft":j(),u.preventDefault(),u.stopPropagation();break;case"ArrowRight":X(),u.preventDefault(),u.stopPropagation();break}},ve=function(){var u=H?i.get(D):i.get(0);window.open(u==null?void 0:u.url)},z=function(){return D!==null?D:o.index},Y=function(){le(function(u){return!u&&$e()})},fe=function(u){e&&u.button===0&&!(u.ctrlKey||u.metaKey)&&(u.preventDefault(),l.push("/@".concat(e.account.acct,"/posts/").concat(e==null?void 0:e.id)),t())},he=i.map(function(a,u){var N=a.meta.getIn(["original","width"])||void 0,M=a.meta.getIn(["original","height"])||void 0,K=e&&s("a",{href:e.url,onClick:fe},void 0,s(Ie,{id:"lightbox.view_context",defaultMessage:"View context"}));return a.type==="image"?s(ne,{previewSrc:a.preview_url,src:a.url,width:N,height:M,alt:a.description,onClick:Y},a.url):a.type==="video"?s(Be,{preview:a.preview_url,blurhash:a.blurhash,src:a.url,width:N,height:M,startTime:d,detailed:!0,autoFocus:u===z(),link:K,alt:a.description,visible:!0},a.url):a.type==="audio"?s(Xe,{src:a.url,alt:a.description,poster:a.preview_url!==a.url?a.preview_url:e==null?void 0:e.getIn(["account","avatar_static"]),backgroundColor:a.meta.getIn(["colors","background"]),foregroundColor:a.meta.getIn(["colors","foreground"]),accentColor:a.meta.getIn(["colors","accent"]),duration:a.meta.getIn(["original","duration"],0)},a.url):a.type==="gifv"?s(Fe,{src:a.url,muted:!0,controls:!1,width:N,height:M,alt:a.description,onClick:Y},a.preview_url):null}).toArray(),me=C.useCallback(Ee(function(){_&&e&&n(Le(e==null?void 0:e.id,_)).then(function(a){var u=a.next;V(u)}).catch(function(){})},300,{leading:!0}),[_,e]),pe=function(){var a=He(regeneratorRuntime.mark(function u(){var N,M;return regeneratorRuntime.wrap(function(R){for(;;)switch(R.prev=R.next){case 0:return R.next=2,n(Oe(e==null?void 0:e.id));case 2:N=R.sent,M=N.next,V(M);case 5:case"end":return R.stop()}},u)}));return function(){return a.apply(this,arguments)}}();if(C.useEffect(function(){pe().then(function(){y(!0)}).catch(function(){y(!0)})},[e==null?void 0:e.id]),C.useEffect(function(){return window.addEventListener("keydown",F,!1),function(){window.removeEventListener("keydown",F)}},[D]),e){if(!c&&x)return s(Ne,{});if(!c)return s(Me,{})}var ge=function(u){u.target.tagName==="DIV"&&t()};return s("div",{className:"media-modal pointer-events-auto fixed inset-0 z-[9999] h-full bg-gray-900/90"},void 0,s("div",{className:"absolute inset-0",role:"presentation"},void 0,s(Re,{onClick:ge,className:b("fixed inset-0 h-full grow transition-all",{"xl:pr-96":!L,"xl:pr-0":L}),justifyContent:"between"},void 0,s(O,{alignItems:"center",justifyContent:"between",className:b("flex-[0_0_60px] p-4 transition-opacity",A)},void 0,s(B,{title:f.formatMessage(P.close),src:Pe,onClick:t,theme:"dark",className:"!p-1.5 hover:scale-105 hover:bg-gray-900",iconClassName:"h-5 w-5"}),s(O,{alignItems:"center",space:2},void 0,s(B,{src:qe,theme:"dark",className:"!p-1.5 hover:scale-105 hover:bg-gray-900",iconClassName:"h-5 w-5",onClick:ve}),e&&s(B,{src:L?We:Ve,title:f.formatMessage(L?P.minimize:P.expand),theme:"dark",className:"hidden !p-1.5 hover:scale-105 hover:bg-gray-900 xl:block",iconClassName:"h-5 w-5",onClick:function(){return ue(!L)}}))),s("div",{className:"relative h-[calc(100vh-120px)] w-full grow"},void 0,H&&s("div",{className:b("absolute inset-y-0 left-5 z-10 flex items-center transition-opacity",A)},void 0,E.createElement("button",{tabIndex:0,className:"flex h-10 w-10 items-center justify-center rounded-full bg-gray-900 text-white",ref:De("Backspace"),onClick:j,"aria-label":f.formatMessage(P.previous)},s(G,{src:Ae,className:"h-5 w-5"}))),s(Ue,{style:tt,containerStyle:at,onChangeIndex:de,index:z()},void 0,he),H&&s("div",{className:b("absolute inset-y-0 right-5 z-10 flex items-center transition-opacity",A)},void 0,s("button",{tabIndex:0,className:"flex h-10 w-10 items-center justify-center rounded-full bg-gray-900 text-white",onClick:X,"aria-label":f.formatMessage(P.next)},void 0,s(G,{src:we,className:"h-5 w-5"})))),c&&s(O,{justifyContent:"center",className:b("flex-[0_0_60px] transition-opacity",A)},void 0,s(ze,{status:c,space:"md",statusActionButtonTheme:"inverse"}))),c&&s("div",{className:b("-right-96 hidden bg-white transition-all xl:fixed xl:inset-y-0 xl:right-0 xl:flex xl:w-96 xl:flex-col",{"xl:!-right-96":L})},void 0,s(je,{status:c,withMedia:!1,useWindowScroll:!1,itemClassName:"px-4",next:_,handleLoadMore:me}))))};export{kt as default};
